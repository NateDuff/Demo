trigger:
- main
- development
- feature*

pool:
  vmImage: 'ubuntu-20.04'

variables:
   major: 1
   minor: 1

stages:
  - stage: Build
    jobs:
      - job: buildApp
        displayName: Build Application
        steps:
          - powershell: | 
              Write-Host "Build application step"
            displayName: Run Build Application Script

  - stage: Promotion
    jobs:
      - job: promotion
        displayName: Release Promotion
        variables:
          patch: $[counter(variables['build.sourcebranchname'], 0)]
        steps:
          - checkout: self

          - powershell: | 
              Write-Host "Stage promo"

              git checkout $(Build.SourceBranchName)

              git clone --mirror https://$env:SYSTEM_ACCESSTOKEN@dev.azure.com/NateDuff/Duff%20Blog/_git/Demo .

              git remote add GHorigin https://github.com/NateDuff/Demo.git

              git push --mirror https://$(GHPAT)@github.com/NateDuff/Demo.git
            displayName: Promotion Script
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)

          - pwsh: |
              $data = IRM https://$(GHPAT)@github.com/NateDuff/Demo/releases.atom -UseBasicParsing
              
              $tags = $data.title

              Write-Host "Tags: $tags"
              
              if ($tags.Count -gt 1) {
                $tags = $tags -join ","
              } else {
                $tags = ""
              }
              
              Write-Host "##vso[task.setvariable variable=tags;]$tags"
              Write-Host "Tags: $tags"
            displayName: Get Latest Tags
          
          - powershell: |
              Write-Host "##vso[build.updatebuildnumber]v$(major).$(minor).$(patch)"
          
          - task: GitHubRelease@1  
            displayName: Create GitHub Release  
            inputs:  
              gitHubConnection: MyGitHubServiceConnection  
              repositoryName: 'NateDuff/Demo'
              tagSource: userSpecifiedTag  
              tag: '$(Build.BuildNumber),v1.1.50$(tags)'
              title: '$(Build.BuildNumber)'  
              releaseNotesFilePath: './releaseNotes.md'
              assets: '**/*.md'  
              addChangeLog: false
