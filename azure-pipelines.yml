trigger:
- main
- development
- feature*

pool:
  vmImage: 'ubuntu-20.04'

variables:
   major: 1
   minor: 1

stages:
  - stage: Build
    jobs:
      - job: buildApp
        displayName: Build Application
        steps:
          - powershell: | 
              Write-Host "Build application step"
            displayName: Run Build Application Script

  - stage: Promotion
    jobs:
      - job: promotion
        displayName: Release Promotion
        variables:
          patch: $[counter(variables['build.sourcebranchname'], 0)]
        steps:
          - checkout: self

          - powershell: | 
              Write-Host "Stage promotion"

              git checkout $(Build.SourceBranchName)

              git clone --mirror https://$env:SYSTEM_ACCESSTOKEN@dev.azure.com/NateDuff/Duff%20Blog/_git/Demo .

              git remote add GHorigin https://github.com/NateDuff/Demo.git

              git push --mirror https://$(GHPAT)@github.com/NateDuff/Demo.git
            displayName: Promotion Script
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          
          - bash: |
              echo "##vso[build.updatebuildnumber]$(major).$(minor)-R.$(patch)"
          
          - task: GitHubRelease@1  
            displayName: Create GitHub Release  
            inputs:  
              gitHubConnection: MyGitHubServiceConnection  
              repositoryName: 'NateDuff/Demo'
              tagSource: userSpecifiedTag  
              tag: '$(Build.BuildNumber)'  
              title: '$(Build.BuildNumber)'  
              releaseNotesFilePath: './releaseNotes.md'
              assets: '**/*.md'  
              addChangeLog: false
